# Template System Documentation

## Overview

The Template System is a sophisticated equipment management solution that automatically selects the best equipment for a character based on their job class and predefined equipment set preferences. It replaces complex SQL queries with maintainable TypeScript services.

## Table Structure

### 1. `equipment_template` Table
Stores equipment set preferences for different character builds.

```sql
CREATE TABLE public.equipment_template (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  name text NOT NULL,
  description text NULL,
  hat_set_id bigint NULL,
  top_set_id bigint NULL,
  bottom_set_id bigint NULL,
  weapon_set_id bigint NULL,
  secondary_set_id bigint NULL,
  gloves_set_id bigint NULL,
  shoes_set_id bigint NULL,
  cape_set_id bigint NULL,
  shoulder_set_id bigint NULL,
  belt_set_id bigint NULL,
  face_accessory_set_id bigint NULL,
  eye_accessory_set_id bigint NULL,
  earring_set_id bigint NULL,
  ring_1_set_id bigint NULL,
  ring_2_set_id bigint NULL,
  ring_3_set_id bigint NULL,
  ring_4_set_id bigint NULL,
  pendant_1_set_id bigint NULL,
  pendant_2_set_id bigint NULL,
  emblem_set_id bigint NULL,
  badge_set_id bigint NULL,
  heart_set_id bigint NULL,
  pocket_set_id bigint NULL,
  CONSTRAINT equipment_template_pkey PRIMARY KEY (id)
);
```

### 2. `sets` Table
Maps set IDs to set names.

```sql
CREATE TABLE public.sets (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  set text NOT NULL,
  CONSTRAINT sets_pkey PRIMARY KEY (id),
  CONSTRAINT sets_set_key UNIQUE (set)
);
```

### 3. `equipment_template_info` Table
Stores starforce progression information for each slot in a template.

```sql
CREATE TABLE public.equipment_template_info (
  id bigint GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  template_id bigint NOT NULL,
  slot_name text NOT NULL,
  current_starforce bigint NOT NULL DEFAULT '0'::bigint,
  target_starforce bigint NULL,
  slot_type text NOT NULL,
  CONSTRAINT equipment_template_info_pkey PRIMARY KEY (id),
  CONSTRAINT equipment_template_info_template_id_fkey 
    FOREIGN KEY (template_id) REFERENCES equipment_template (id)
);
```

## Available Equipment Sets

| Set Name | Level Range | Item Count | Description |
|----------|-------------|------------|-------------|
| **Eternal** | 250 | 67 | End-game equipment set |
| **Generic** | 100+ | 69 | Common equipment available to all classes |
| **Pensalir** | 140 | 63 | Mid-game equipment set |
| **Arcane Umbra** | 200 | 58 | High-end equipment set |
| **Absolab** | 160 | 58 | Boss equipment set |
| **Fafnir** | 150 | 48 | Root Abyss equipment set |
| **Generic II** | 140 | 42 | Enhanced common equipment |
| **Pitched** | 200 | 18 | Alternative high-level set |
| **Boss Accessory** | 100+ | 10 | Common boss accessories |
| **Boss Accessory II** | 135+ | 6 | Enhanced boss accessories |
| **Superior Gollux** | 150 | 4 | High-tier Gollux accessories |
| **Sweetwater** | 160 | 5 | Alternative boss equipment |
| **Reinforced Gollux** | 140 | 4 | Mid-tier Gollux accessories |
| **Transfer** | 150 | 3 | Transfer-only equipment |
| **Dawn** | 140 | 4 | Special event equipment |
| **Meister** | 140 | 2 | Crafted equipment |
| **Special** | 130 | 2 | Unique equipment pieces |
| **Advanced** | 100 | 1 | Special equipment |
| **Brilliant** | 250 | 1 | Ultra rare equipment |
| **Event** | 120 | 1 | Event-specific equipment |
| **NLC** | 125 | 1 | New Leaf City equipment |
| **Oz** | 110 | 1 | Oz-specific equipment |
| **Sengoku** | 140 | 1 | Sengoku-themed equipment |

## Template Service Implementation

### Core Logic Flow

1. **Template Retrieval**: Get template data using RLS-compliant SupabaseService methods
2. **Set Resolution**: Map set IDs to set names from the `sets` table
3. **Slot Processing**: Convert template columns to active equipment slots
4. **Equipment Selection**: Find best equipment per slot based on job compatibility
5. **Starforce Integration**: Attach current/target starforce data

### Slot Mapping

The service maps template columns to equipment slots:

```typescript
private readonly SLOT_MAPPINGS = {
  hat: 'hat_set_id',
  top: 'top_set_id',
  bottom: 'bottom_set_id',
  weapon: 'weapon_set_id',
  secondary: 'secondary_set_id',
  gloves: 'gloves_set_id',
  shoes: 'shoes_set_id',
  cape: 'cape_set_id',
  shoulder: 'shoulder_set_id',
  belt: 'belt_set_id',
  face: 'face_accessory_set_id',
  eye: 'eye_accessory_set_id',
  earrings: 'earring_set_id',
  ring1: 'ring_1_set_id',
  ring2: 'ring_2_set_id',
  ring3: 'ring_3_set_id',
  ring4: 'ring_4_set_id',
  pendant1: 'pendant_1_set_id',
  pendant2: 'pendant_2_set_id',
  emblem: 'emblem_set_id',
  badge: 'badge_set_id',
  heart: 'heart_set_id',
  pocket: 'pocket_set_id'
};
```

### Equipment Selection Priority

The service selects equipment based on job/class compatibility with the following priority:

1. **Unique class** equipment with specific job compatibility
2. **Class-specific** equipment (magician, warrior, etc.) with job compatibility
3. **Common class** equipment (usable by all)

```typescript
.or(
  `class.eq.common,and(class.eq.${characterClass},job.is.null),and(class.eq.${characterClass},job.cs.{${job}}),and(class.eq.unique,job.cs.{${job}})`
)
.order('class', { ascending: false }) // Prioritize unique > class-specific > common
.order('level', { ascending: false })
```

## API Endpoints

### Get Template Equipment
```http
GET /Templates/{templateId}/equipment?job={jobName}
```

**Parameters:**
- `templateId`: The ID of the equipment template
- `job`: Character job name (e.g., "bishop", "paladin", "night-lord")

**Response:** Array of equipment items with slot information

### Validate Template
```http
GET /Templates/{templateId}/validate?job={jobName}
```

**Parameters:**
- `templateId`: The ID of the equipment template
- `job`: Character job name

**Response:** Validation result with missing slots

## Example Template

The "Newbie" template (ID: 1) demonstrates a typical progression setup:

```json
{
  "id": 1,
  "name": "Newbie",
  "description": "Root Abyss, Absolab and more advanced boss accessories",
  "hat_set_id": 10,      // Fafnir
  "top_set_id": 10,      // Fafnir
  "bottom_set_id": 10,   // Fafnir
  "weapon_set_id": 10,   // Fafnir
  "secondary_set_id": 11, // Generic
  "gloves_set_id": 16,   // Pensalir
  "shoes_set_id": 16,    // Pensalir
  "cape_set_id": 16,     // Pensalir
  "shoulder_set_id": 4,  // Boss Accessory
  "belt_set_id": 4,      // Boss Accessory
  "face_accessory_set_id": 4,  // Boss Accessory
  "eye_accessory_set_id": 4,   // Boss Accessory
  "earring_set_id": 4,   // Boss Accessory
  "ring_1_set_id": 4,    // Boss Accessory
  "ring_2_set_id": 5,    // Boss Accessory II
  "pendant_1_set_id": 4, // Boss Accessory
  "pendant_2_set_id": 5, // Boss Accessory II
  "emblem_set_id": 11,   // Generic
  "badge_set_id": 4,     // Boss Accessory
  "heart_set_id": 11,    // Generic
  "pocket_set_id": 4     // Boss Accessory
}
```

## Benefits Over Raw SQL

### Original Complex Query Issues:
- **Single point of failure**: One massive query doing everything
- **Hard to debug**: Difficult to isolate issues with specific slots
- **Poor maintainability**: Changes require SQL expertise
- **Limited error handling**: Minimal feedback on failures

### Template Service Advantages:
- **Modular design**: Each function handles a specific responsibility
- **Parallel processing**: Equipment fetching for all slots simultaneously
- **Rich error handling**: Detailed logging and graceful failure handling
- **Type safety**: Full TypeScript support with interfaces
- **Easy testing**: Individual functions can be unit tested
- **Maintainable**: Clear, readable code structure

## Performance Considerations

- **Set data caching**: Sets are fetched once per template query
- **Parallel slot processing**: All equipment queries run simultaneously
- **Efficient filtering**: Supabase queries with proper indexing
- **Minimal database roundtrips**: Optimized query patterns

## Job Class Compatibility

The system supports all MapleStory job classes with proper equipment filtering:

- **Warriors**: Paladin, Hero, Dark Knight
- **Magicians**: Archbishop (Bishop), Archmage (Fire/Poison, Ice/Lightning), Blaze Wizard
- **Bowmen**: Marksman, Bowmaster, Pathfinder
- **Thieves**: Night Lord, Shadower, Dual Blade
- **Pirates**: Corsair, Buccaneer, Cannon Shooter
- **And many more...**

The service automatically maps job names to equipment classes using the `getClassByJob` utility function.

## Future Enhancements

- **Template versioning**: Track template changes over time
- **Equipment recommendations**: Suggest optimal set combinations
- **Cost analysis**: Calculate upgrade costs and starforce progression
- **Build comparison**: Compare different template configurations
- **Auto-optimization**: AI-powered equipment selection

---

*This template system successfully replaces complex SQL with maintainable, type-safe TypeScript code while preserving all original functionality and adding enhanced error handling and performance optimizations.*
